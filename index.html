<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>분양 주택 대출 시뮬레이터</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#161616;--panel2:#1f1f1f;--text:#eaeaea;--muted:#a0a0a0;--accent:#4ade80;--border:#2a2a2a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,"Malgun Gothic",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:992px){.grid{grid-template-columns:380px 1fr}}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;gap:8px;align-items:center}
    .card .bd{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row + .row{margin-top:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f0f;color:var(--text)}
    input:focus,select:focus{outline:1px solid #2f2f2f}
    .hint{color:var(--muted);font-size:12px}
    .summary{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .pill{background:#101010;border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill small{display:block;color:var(--muted);font-size:11px}
    .pill b{display:block;margin-top:4px;font-size:15px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#131313;border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:12px}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:nth-child(odd){background:#0e0e0e}
    .hl{background:rgba(16,185,129,.12)}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#111;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#151515}
    .mt8{margin-top:8px}
    .mt16{margin-top:16px}
    .right{float:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .scroll{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- 좌: 입력 -->
      <div class="card">
        <div class="hd">🏠 분양 주택 대출 시뮬레이터</div>
        <div class="bd">
          <div class="row">
            <div>
              <label>분양가(원)</label>
              <input id="price" type="number" value="800000000" />
            </div>
            <div>
              <label>입주까지 개월</label>
              <input id="monthsToCompletion" type="number" value="24" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>계약금 비율(%)</label>
              <input id="contractRate" type="number" value="10" />
            </div>
            <div>
              <label>중도금 총 비율(%)</label>
              <input id="midRate" type="number" value="60" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>중도금 회차</label>
              <input id="midInstalments" type="number" value="6" />
            </div>
            <div>
              <label>중도금 대출 비율(%)</label>
              <input id="midLoanRatio" type="number" value="100" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>중도금 금리(연, %)</label>
              <input id="midAnnualRate" type="number" value="6" step="0.01" />
            </div>
            <div>
              <label>LTV(%)</label>
              <input id="ltv" type="number" value="70" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>모기지 금리(연, %)</label>
              <input id="mortAnnualRate" type="number" value="4.5" step="0.01" />
            </div>
            <div>
              <label>상환기간(년)</label>
              <input id="mortYears" type="number" value="30" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>상환방식</label>
              <select id="mortType">
                <option>원리금균등</option>
                <option>원금균등</option>
                <option>만기일시</option>
              </select>
            </div>
            <div>
              <label>거치 개월</label>
              <input id="mortGraceMonths" type="number" value="0" />
            </div>
          </div>
          <p class="hint mt8">* 단순화 가정: 중도금 대출은 회차별 실행액에 대해 이자만 납부하며 입주 시 모기지로 대환됩니다. 세금/수수료/취득세 등은 제외.</p>
          <div class="tools mt16">
            <button class="btn" id="btnExport">CSV 내보내기</button>
          </div>
        </div>
      </div>

      <!-- 우: 결과 -->
      <div class="card">
        <div class="hd">📊 요약</div>
        <div class="bd">
          <div class="summary" id="summary"></div>
        </div>
      </div>
    </div>

    <div class="card mt16">
      <div class="hd">📅 월별 현금흐름 (분양~입주 + 입주 후 12개월)</div>
      <div class="bd">
        <div class="scroll"><table id="table"></table></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (v)=> (Math.round(v)).toLocaleString('ko-KR');
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

    function pmtEqual(P, annualRate, years){
      const n = Math.round(years*12);
      const r = annualRate/12;
      if(r === 0) return P/n;
      return P * (r) / (1 - Math.pow(1+r, -n));
    }

    function buildSchedule(params){
      const {price, contractRate, midRate, midInstalments, midLoanRatio, monthsToCompletion, midAnnualRate, ltv, mortAnnualRate, mortYears, mortType, mortGraceMonths} = params;
      const contract = price * contractRate;
      const midTotal = price * midRate;

      const months = [];
      for(let i=1;i<=midInstalments;i++) months.push(Math.round((i * monthsToCompletion) / (midInstalments+1)));

      const perMid = midTotal / midInstalments;
      let midLoanOutstanding = 0;
      let totalMidInterest = 0;

      const totalMonths = monthsToCompletion + 12;
      const monthlyCF = Array.from({length: totalMonths}, (_,i)=> ({month:i+1,inflow:0,outflow:0,detail:[]}));

      monthlyCF[0].outflow += contract;
      monthlyCF[0].detail.push(`계약금 ${fmt(contract)}원`);

      const rMid = midAnnualRate/12;
      const midEvents = months.map(m=>({m,amount:perMid}));

      for(let t=1;t<=monthsToCompletion;t++){
        const ev = midEvents.find(e=>e.m===t);
        if(ev){
          const loanPart = ev.amount * midLoanRatio;
          const cashPart = ev.amount - loanPart;
          midLoanOutstanding += loanPart;
          if(cashPart>0){
            monthlyCF[t-1].outflow += cashPart;
            monthlyCF[t-1].detail.push(`중도금 자기자금 ${fmt(cashPart)}원`);
          }
          monthlyCF[t-1].detail.push(`중도금 대출 실행 ${fmt(loanPart)}원`);
        }
        if(midLoanOutstanding>0){
          const interest = midLoanOutstanding * rMid;
          totalMidInterest += interest;
          monthlyCF[t-1].outflow += interest;
          monthlyCF[t-1].detail.push(`중도금 이자 ${fmt(interest)}원`);
        }
      }

      const maxMortgage = price * ltv;
      const mortgagePrincipal = Math.min(maxMortgage, price - contract);
      const needOwnAtCompletion = (price - contract) - mortgagePrincipal;

      const completionIdx = monthsToCompletion-1;
      if(midLoanOutstanding>0){
        monthlyCF[completionIdx].detail.push(`중도금 대출 상환 ${fmt(midLoanOutstanding)}원 (모기지 대환)`);
      }
      if(needOwnAtCompletion>0){
        monthlyCF[completionIdx].outflow += needOwnAtCompletion;
        monthlyCF[completionIdx].detail.push(`잔금 자기자금 ${fmt(needOwnAtCompletion)}원`);
      }

      const rMort = mortAnnualRate/12;
      const N = Math.round(mortYears*12);
      let mortOutstanding = mortgagePrincipal;
      let firstMonthPayment = 0;

      for(let k=1;k<=12;k++){
        const idx = monthsToCompletion + (k-1);
        let interest = mortOutstanding * rMort;
        if(k <= mortGraceMonths){
          monthlyCF[idx].outflow += interest;
          monthlyCF[idx].detail.push(`모기지 이자(거치) ${fmt(interest)}원`);
          continue;
        }
        if(mortType === '원리금균등'){
          const pay = pmtEqual(mortOutstanding, mortAnnualRate, (N-(k-1))/12);
          const principal = Math.max(0, pay - interest);
          mortOutstanding = Math.max(0, mortOutstanding - principal);
          monthlyCF[idx].outflow += pay;
          monthlyCF[idx].detail.push(`모기지 상환(원리금균등) ${fmt(pay)}원, 원금 ${fmt(principal)}원, 이자 ${fmt(interest)}원`);
          if(k === mortGraceMonths+1) firstMonthPayment = pay;
        }else if(mortType === '원금균등'){
          const principal = mortgagePrincipal / N;
          const pay = principal + interest;
          mortOutstanding = Math.max(0, mortOutstanding - principal);
          monthlyCF[idx].outflow += pay;
          monthlyCF[idx].detail.push(`모기지 상환(원금균등) ${fmt(pay)}원, 원금 ${fmt(principal)}원, 이자 ${fmt(interest)}원`);
          if(k === mortGraceMonths+1) firstMonthPayment = pay;
        }else{
          monthlyCF[idx].outflow += interest;
          monthlyCF[idx].detail.push(`모기지 이자(만기일시) ${fmt(interest)}원`);
          if(k === mortGraceMonths+1) firstMonthPayment = interest;
        }
      }

      return {contract, totalMidInterest, mortgagePrincipal, needOwnAtCompletion: Math.max(0, needOwnAtCompletion), firstMonthPayment, monthlyCF, perMid, months};
    }

    function render(){
      const params = {
        price: clamp(Number($("price").value)||0, 0, 10_000_000_000_000),
        contractRate: clamp((Number($("contractRate").value)||0)/100,0,1),
        midRate: clamp((Number($("midRate").value)||0)/100,0,1),
        midInstalments: clamp(parseInt($("midInstalments").value||'0'),1,12),
        midLoanRatio: clamp((Number($("midLoanRatio").value)||0)/100,0,1),
        monthsToCompletion: clamp(parseInt($("monthsToCompletion").value||'0'),1,120),
        midAnnualRate: clamp((Number($("midAnnualRate").value)||0)/100, 0, 0.3),
        ltv: clamp((Number($("ltv").value)||0)/100, 0, 1),
        mortAnnualRate: clamp((Number($("mortAnnualRate").value)||0)/100, 0, 0.3),
        mortYears: clamp(parseInt($("mortYears").value||'0'), 1, 40),
        mortType: $("mortType").value,
        mortGraceMonths: clamp(parseInt($("mortGraceMonths").value||'0'),0,60)
      };
      const res = buildSchedule(params);

      // Summary
      const sum = $("summary");
      sum.innerHTML = '';
      const items = [
        ["계약금", `${fmt(res.contract)} 원`],
        ["중도금 회차당", `${fmt((params.price*params.midRate)/params.midInstalments)} 원`],
        ["입주 전 이자총액(중도금)", `${fmt(res.totalMidInterest)} 원`],
        ["모기지 실행액", `${fmt(res.mortgagePrincipal)} 원`],
        ["입주 시 추가 자기자금", `${fmt(res.needOwnAtCompletion)} 원`],
        ["입주 후 첫 납부액", `${fmt(res.firstMonthPayment)} 원`]
      ];
      items.forEach(([k,v])=>{
        const d=document.createElement('div');d.className='pill';
        d.innerHTML = `<small>${k}</small><b class="mono">${v}</b>`; sum.appendChild(d);
      });

      // Table
      const tbl = $("table");
      tbl.innerHTML = `<thead><tr><th>월</th><th style="text-align:right">유입</th><th style="text-align:right">유출</th><th>상세</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      res.monthlyCF.forEach((m,i)=>{
        const tr = document.createElement('tr');
        if(i === (params.monthsToCompletion-1)) tr.className='hl';
        tr.innerHTML = `<td>${m.month}</td><td style="text-align:right" class="mono">${fmt(m.inflow)}</td><td style="text-align:right" class="mono">${fmt(m.outflow)}</td><td>${m.detail.join(' | ')}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);

      // Export handler
      $("btnExport").onclick = ()=>{
        const rows = [["월","유입","유출","상세"], ...res.monthlyCF.map(m=>[m.month, Math.round(m.inflow), Math.round(m.outflow), m.detail.join(' | ')])];
        const csv = rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','\"')}"`).join(',')).join('\n');
        const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'housing_loan_simulation.csv'; a.click();
        URL.revokeObjectURL(url);
      };
    }

    // 이벤트 바인딩
    ["price","monthsToCompletion","contractRate","midRate","midInstalments","midLoanRatio","midAnnualRate","ltv","mortAnnualRate","mortYears","mortType","mortGraceMonths"].forEach(id=>{
      $(id).addEventListener('input', render);
      $(id).addEventListener('change', render);
    });

    render();
  </script>
</body>
</html>

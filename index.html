<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ë¶„ì–‘ ì£¼íƒ ëŒ€ì¶œ ì‹œë®¬ë ˆì´í„°</title>
  <style>
    :root{--bg:#0b0b0b;--panel:#161616;--panel2:#1f1f1f;--text:#eaeaea;--muted:#a0a0a0;--accent:#4ade80;--border:#2a2a2a}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,"Malgun Gothic",sans-serif}
    .wrap{max-width:1200px;margin:24px auto;padding:16px}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media(min-width:992px){.grid{grid-template-columns:380px 1fr}}
    .card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:700;display:flex;gap:8px;align-items:center}
    .card .bd{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row + .row{margin-top:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#0f0f0f;color:var(--text)}
    input:focus,select:focus{outline:1px solid #2f2f2f}
    .hint{color:var(--muted);font-size:12px}
    .summary{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px}
    .pill{background:#101010;border:1px solid var(--border);border-radius:12px;padding:12px}
    .pill small{display:block;color:var(--muted);font-size:11px}
    .pill b{display:block;margin-top:4px;font-size:15px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#131313;border-bottom:1px solid var(--border);text-align:left;padding:10px;font-size:12px}
    tbody td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
    tbody tr:nth-child(odd){background:#0e0e0e}
    .hl{background:rgba(16,185,129,.12)}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--border);background:#111;color:var(--text);padding:10px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{background:#151515}
    .mt8{margin-top:8px}
    .mt16{margin-top:16px}
    .right{float:right}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .scroll{max-height:520px;overflow:auto;border:1px solid var(--border);border-radius:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="grid">
      <!-- ì¢Œ: ì…ë ¥ -->
      <div class="card">
        <div class="hd">ğŸ  ë¶„ì–‘ ì£¼íƒ ëŒ€ì¶œ ì‹œë®¬ë ˆì´í„°</div>
        <div class="bd">
          <div class="row">
            <div>
              <label>ë¶„ì–‘ê°€(ì›)</label>
              <input id="price" type="number" value="800000000" />
            </div>
            <div>
              <label>ì…ì£¼ê¹Œì§€ ê°œì›”</label>
              <input id="monthsToCompletion" type="number" value="24" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ê³„ì•½ê¸ˆ ë¹„ìœ¨(%)</label>
              <input id="contractRate" type="number" value="10" />
            </div>
            <div>
              <label>ì¤‘ë„ê¸ˆ ì´ ë¹„ìœ¨(%)</label>
              <input id="midRate" type="number" value="60" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ì¤‘ë„ê¸ˆ íšŒì°¨</label>
              <input id="midInstalments" type="number" value="6" />
            </div>
            <div>
              <label>ì¤‘ë„ê¸ˆ ëŒ€ì¶œ ë¹„ìœ¨(%)</label>
              <input id="midLoanRatio" type="number" value="100" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ì¤‘ë„ê¸ˆ ê¸ˆë¦¬(ì—°, %)</label>
              <input id="midAnnualRate" type="number" value="6" step="0.01" />
            </div>
            <div>
              <label>LTV(%)</label>
              <input id="ltv" type="number" value="70" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ëª¨ê¸°ì§€ ê¸ˆë¦¬(ì—°, %)</label>
              <input id="mortAnnualRate" type="number" value="4.5" step="0.01" />
            </div>
            <div>
              <label>ìƒí™˜ê¸°ê°„(ë…„)</label>
              <input id="mortYears" type="number" value="30" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ìƒí™˜ë°©ì‹</label>
              <select id="mortType">
                <option>ì›ë¦¬ê¸ˆê· ë“±</option>
                <option>ì›ê¸ˆê· ë“±</option>
                <option>ë§Œê¸°ì¼ì‹œ</option>
              </select>
            </div>
            <div>
              <label>ê±°ì¹˜ ê°œì›”</label>
              <input id="mortGraceMonths" type="number" value="0" />
            </div>
          </div>
          <p class="hint mt8">* ë‹¨ìˆœí™” ê°€ì •: ì¤‘ë„ê¸ˆ ëŒ€ì¶œì€ íšŒì°¨ë³„ ì‹¤í–‰ì•¡ì— ëŒ€í•´ ì´ìë§Œ ë‚©ë¶€í•˜ë©° ì…ì£¼ ì‹œ ëª¨ê¸°ì§€ë¡œ ëŒ€í™˜ë©ë‹ˆë‹¤. ì„¸ê¸ˆ/ìˆ˜ìˆ˜ë£Œ/ì·¨ë“ì„¸ ë“±ì€ ì œì™¸.</p>
          <div class="tools mt16">
            <button class="btn" id="btnExport">CSV ë‚´ë³´ë‚´ê¸°</button>
          </div>
        </div>
      </div>

      <!-- ìš°: ê²°ê³¼ -->
      <div class="card">
        <div class="hd">ğŸ“Š ìš”ì•½</div>
        <div class="bd">
          <div class="summary" id="summary"></div>
        </div>
      </div>
    </div>

    <div class="card mt16">
      <div class="hd">ğŸ“… ì›”ë³„ í˜„ê¸ˆíë¦„ (ë¶„ì–‘~ì…ì£¼ + ì…ì£¼ í›„ 12ê°œì›”)</div>
      <div class="bd">
        <div class="scroll"><table id="table"></table></div>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    const fmt = (v)=> (Math.round(v)).toLocaleString('ko-KR');
    const clamp = (v,min,max)=> Math.max(min, Math.min(max, v));

    function pmtEqual(P, annualRate, years){
      const n = Math.round(years*12);
      const r = annualRate/12;
      if(r === 0) return P/n;
      return P * (r) / (1 - Math.pow(1+r, -n));
    }

    function buildSchedule(params){
      const {price, contractRate, midRate, midInstalments, midLoanRatio, monthsToCompletion, midAnnualRate, ltv, mortAnnualRate, mortYears, mortType, mortGraceMonths} = params;
      const contract = price * contractRate;
      const midTotal = price * midRate;

      const months = [];
      for(let i=1;i<=midInstalments;i++) months.push(Math.round((i * monthsToCompletion) / (midInstalments+1)));

      const perMid = midTotal / midInstalments;
      let midLoanOutstanding = 0;
      let totalMidInterest = 0;

      const totalMonths = monthsToCompletion + 12;
      const monthlyCF = Array.from({length: totalMonths}, (_,i)=> ({month:i+1,inflow:0,outflow:0,detail:[]}));

      monthlyCF[0].outflow += contract;
      monthlyCF[0].detail.push(`ê³„ì•½ê¸ˆ ${fmt(contract)}ì›`);

      const rMid = midAnnualRate/12;
      const midEvents = months.map(m=>({m,amount:perMid}));

      for(let t=1;t<=monthsToCompletion;t++){
        const ev = midEvents.find(e=>e.m===t);
        if(ev){
          const loanPart = ev.amount * midLoanRatio;
          const cashPart = ev.amount - loanPart;
          midLoanOutstanding += loanPart;
          if(cashPart>0){
            monthlyCF[t-1].outflow += cashPart;
            monthlyCF[t-1].detail.push(`ì¤‘ë„ê¸ˆ ìê¸°ìê¸ˆ ${fmt(cashPart)}ì›`);
          }
          monthlyCF[t-1].detail.push(`ì¤‘ë„ê¸ˆ ëŒ€ì¶œ ì‹¤í–‰ ${fmt(loanPart)}ì›`);
        }
        if(midLoanOutstanding>0){
          const interest = midLoanOutstanding * rMid;
          totalMidInterest += interest;
          monthlyCF[t-1].outflow += interest;
          monthlyCF[t-1].detail.push(`ì¤‘ë„ê¸ˆ ì´ì ${fmt(interest)}ì›`);
        }
      }

      const maxMortgage = price * ltv;
      const mortgagePrincipal = Math.min(maxMortgage, price - contract);
      const needOwnAtCompletion = (price - contract) - mortgagePrincipal;

      const completionIdx = monthsToCompletion-1;
      if(midLoanOutstanding>0){
        monthlyCF[completionIdx].detail.push(`ì¤‘ë„ê¸ˆ ëŒ€ì¶œ ìƒí™˜ ${fmt(midLoanOutstanding)}ì› (ëª¨ê¸°ì§€ ëŒ€í™˜)`);
      }
      if(needOwnAtCompletion>0){
        monthlyCF[completionIdx].outflow += needOwnAtCompletion;
        monthlyCF[completionIdx].detail.push(`ì”ê¸ˆ ìê¸°ìê¸ˆ ${fmt(needOwnAtCompletion)}ì›`);
      }

      const rMort = mortAnnualRate/12;
      const N = Math.round(mortYears*12);
      let mortOutstanding = mortgagePrincipal;
      let firstMonthPayment = 0;

      for(let k=1;k<=12;k++){
        const idx = monthsToCompletion + (k-1);
        let interest = mortOutstanding * rMort;
        if(k <= mortGraceMonths){
          monthlyCF[idx].outflow += interest;
          monthlyCF[idx].detail.push(`ëª¨ê¸°ì§€ ì´ì(ê±°ì¹˜) ${fmt(interest)}ì›`);
          continue;
        }
        if(mortType === 'ì›ë¦¬ê¸ˆê· ë“±'){
          const pay = pmtEqual(mortOutstanding, mortAnnualRate, (N-(k-1))/12);
          const principal = Math.max(0, pay - interest);
          mortOutstanding = Math.max(0, mortOutstanding - principal);
          monthlyCF[idx].outflow += pay;
          monthlyCF[idx].detail.push(`ëª¨ê¸°ì§€ ìƒí™˜(ì›ë¦¬ê¸ˆê· ë“±) ${fmt(pay)}ì›, ì›ê¸ˆ ${fmt(principal)}ì›, ì´ì ${fmt(interest)}ì›`);
          if(k === mortGraceMonths+1) firstMonthPayment = pay;
        }else if(mortType === 'ì›ê¸ˆê· ë“±'){
          const principal = mortgagePrincipal / N;
          const pay = principal + interest;
          mortOutstanding = Math.max(0, mortOutstanding - principal);
          monthlyCF[idx].outflow += pay;
          monthlyCF[idx].detail.push(`ëª¨ê¸°ì§€ ìƒí™˜(ì›ê¸ˆê· ë“±) ${fmt(pay)}ì›, ì›ê¸ˆ ${fmt(principal)}ì›, ì´ì ${fmt(interest)}ì›`);
          if(k === mortGraceMonths+1) firstMonthPayment = pay;
        }else{
          monthlyCF[idx].outflow += interest;
          monthlyCF[idx].detail.push(`ëª¨ê¸°ì§€ ì´ì(ë§Œê¸°ì¼ì‹œ) ${fmt(interest)}ì›`);
          if(k === mortGraceMonths+1) firstMonthPayment = interest;
        }
      }

      return {contract, totalMidInterest, mortgagePrincipal, needOwnAtCompletion: Math.max(0, needOwnAtCompletion), firstMonthPayment, monthlyCF, perMid, months};
    }

    function render(){
      const params = {
        price: clamp(Number($("price").value)||0, 0, 10_000_000_000_000),
        contractRate: clamp((Number($("contractRate").value)||0)/100,0,1),
        midRate: clamp((Number($("midRate").value)||0)/100,0,1),
        midInstalments: clamp(parseInt($("midInstalments").value||'0'),1,12),
        midLoanRatio: clamp((Number($("midLoanRatio").value)||0)/100,0,1),
        monthsToCompletion: clamp(parseInt($("monthsToCompletion").value||'0'),1,120),
        midAnnualRate: clamp((Number($("midAnnualRate").value)||0)/100, 0, 0.3),
        ltv: clamp((Number($("ltv").value)||0)/100, 0, 1),
        mortAnnualRate: clamp((Number($("mortAnnualRate").value)||0)/100, 0, 0.3),
        mortYears: clamp(parseInt($("mortYears").value||'0'), 1, 40),
        mortType: $("mortType").value,
        mortGraceMonths: clamp(parseInt($("mortGraceMonths").value||'0'),0,60)
      };
      const res = buildSchedule(params);

      // Summary
      const sum = $("summary");
      sum.innerHTML = '';
      const items = [
        ["ê³„ì•½ê¸ˆ", `${fmt(res.contract)} ì›`],
        ["ì¤‘ë„ê¸ˆ íšŒì°¨ë‹¹", `${fmt((params.price*params.midRate)/params.midInstalments)} ì›`],
        ["ì…ì£¼ ì „ ì´ìì´ì•¡(ì¤‘ë„ê¸ˆ)", `${fmt(res.totalMidInterest)} ì›`],
        ["ëª¨ê¸°ì§€ ì‹¤í–‰ì•¡", `${fmt(res.mortgagePrincipal)} ì›`],
        ["ì…ì£¼ ì‹œ ì¶”ê°€ ìê¸°ìê¸ˆ", `${fmt(res.needOwnAtCompletion)} ì›`],
        ["ì…ì£¼ í›„ ì²« ë‚©ë¶€ì•¡", `${fmt(res.firstMonthPayment)} ì›`]
      ];
      items.forEach(([k,v])=>{
        const d=document.createElement('div');d.className='pill';
        d.innerHTML = `<small>${k}</small><b class="mono">${v}</b>`; sum.appendChild(d);
      });

      // Table
      const tbl = $("table");
      tbl.innerHTML = `<thead><tr><th>ì›”</th><th style="text-align:right">ìœ ì…</th><th style="text-align:right">ìœ ì¶œ</th><th>ìƒì„¸</th></tr></thead>`;
      const tbody = document.createElement('tbody');
      res.monthlyCF.forEach((m,i)=>{
        const tr = document.createElement('tr');
        if(i === (params.monthsToCompletion-1)) tr.className='hl';
        tr.innerHTML = `<td>${m.month}</td><td style="text-align:right" class="mono">${fmt(m.inflow)}</td><td style="text-align:right" class="mono">${fmt(m.outflow)}</td><td>${m.detail.join(' | ')}</td>`;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);

      // Export handler
      $("btnExport").onclick = ()=>{
        const rows = [["ì›”","ìœ ì…","ìœ ì¶œ","ìƒì„¸"], ...res.monthlyCF.map(m=>[m.month, Math.round(m.inflow), Math.round(m.outflow), m.detail.join(' | ')])];
        const csv = rows.map(r=> r.map(v=>`"${String(v).replaceAll('"','\"')}"`).join(',')).join('\n');
        const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'housing_loan_simulation.csv'; a.click();
        URL.revokeObjectURL(url);
      };
    }

    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    ["price","monthsToCompletion","contractRate","midRate","midInstalments","midLoanRatio","midAnnualRate","ltv","mortAnnualRate","mortYears","mortType","mortGraceMonths"].forEach(id=>{
      $(id).addEventListener('input', render);
      $(id).addEventListener('change', render);
    });

    render();
  </script>
</body>
</html>
